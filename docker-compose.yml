
services:
  # NATS message broker
  nats:
    image: nats:2.9-alpine
    container_name: secbeat-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["-js", "-m", "8222"]
    networks:
      - secbeat-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Test Origin Server (backend)
  test-origin:
    build:
      context: .
      dockerfile: Dockerfile
    image: secbeat/mitigation-node:latest
    container_name: secbeat-test-origin
    command: ["test-origin"]
    ports:
      - "8080:8080"
    networks:
      - secbeat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Mitigation Node (proxy)
  mitigation-node:
    build:
      context: .
      dockerfile: Dockerfile
    image: secbeat/mitigation-node:latest
    container_name: secbeat-mitigation
    depends_on:
      - nats
      - test-origin
    ports:
      - "8443:8443"   # HTTPS proxy
      - "9090:9090"   # Prometheus metrics (mitigation node)
      - "9191:9191"   # Internal metrics
      - "9999:9999"   # Management API
    environment:
      - SECBEAT_CONFIG=config.dev
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      - SYN_COOKIE_SECRET=${SYN_COOKIE_SECRET:-default-secret-change-in-production}
      - SECBEAT_AUTO_GENERATE_CERTS=${SECBEAT_AUTO_GENERATE_CERTS:-true}
      - SECBEAT_HOSTNAME=${SECBEAT_HOSTNAME:-localhost}
      - SECBEAT_TLS_ENABLED=${SECBEAT_TLS_ENABLED:-false}
      - MANAGEMENT_API_KEY=${MANAGEMENT_API_KEY:-dev-api-key-change-in-production}
      - ORCHESTRATOR_API_KEY=${ORCHESTRATOR_API_KEY:-dev-orchestrator-key}
    volumes:
      - ./config.dev.toml:/app/config.dev.toml:ro
      - ./mitigation-node/config:/app/config:ro
      - ./mitigation-node/certs:/app/certs:ro
      - ./logs:/app/logs
    networks:
      - secbeat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9191/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Orchestrator Node (optional)
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator.Dockerfile
    image: secbeat/orchestrator-node:latest
    container_name: secbeat-orchestrator
    ports:
      - "3030:3030"   # Orchestrator API
      - "9091:9091"   # Orchestrator metrics
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      - NATS_URL=nats://nats:4222
      - ORCHESTRATOR_LISTEN_ADDR=0.0.0.0:3030
      - ORCHESTRATOR_METRICS_ADDR=0.0.0.0:9091
    networks:
      - secbeat-network
    depends_on:
      - nats

  # Prometheus monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: secbeat-prometheus
    ports:
      - "9092:9090"   # Prometheus web UI (mapped to avoid conflict)
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - secbeat-network

  # Grafana dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: secbeat-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=secbeat123
    volumes:
      - ./docker/grafana:/etc/grafana/provisioning
      - grafana-storage:/var/lib/grafana
    networks:
      - secbeat-network

networks:
  secbeat-network:
    driver: bridge

volumes:
  grafana-storage:
