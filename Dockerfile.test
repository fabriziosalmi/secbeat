# SecBeat Test Container
# 
# This Dockerfile creates a containerized test environment with:
# - Linux capabilities (CAP_NET_ADMIN, CAP_NET_RAW) for XDP/eBPF tests
# - Rust toolchain and build dependencies
# - Network namespace isolation for safe testing
# - No sudo requirements
#
# Usage:
#   docker build -t secbeat-test -f Dockerfile.test .
#   docker run --rm --cap-add=NET_ADMIN --cap-add=NET_RAW -v $(pwd):/workspace secbeat-test
#
# Design rationale:
# - Uses CAP_NET_ADMIN instead of --privileged for minimal permissions
# - Mounts workspace as volume for live code updates
# - Runs tests as non-root user (secbeat) with capabilities
# - Isolated network namespace prevents host interference

FROM rust:1.80-bookworm

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Build essentials
    build-essential \
    pkg-config \
    libssl-dev \
    # Network tools for testing
    iproute2 \
    iptables \
    iputils-ping \
    net-tools \
    tcpdump \
    curl \
    jq \
    # eBPF/XDP dependencies (Linux only)
    llvm \
    clang \
    # Debugging tools
    strace \
    gdb \
    # Memory leak detection
    valgrind \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# Create workspace directory
WORKDIR /workspace

# Set environment variables for testing
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info

# Default command: run comprehensive test suite
CMD ["bash", "-c", "cargo test --workspace --all-features -- --nocapture"]

# Labels for metadata
LABEL maintainer="Fabrizio Salmi"
LABEL description="SecBeat containerized test environment with Linux capabilities"
LABEL version="1.0"
